#!/usr/bin/env bash
set -euo pipefail

REPO="https://github.com/SeaDve/Kooha"
REF="v2.2.3"
DEST="$HOME/Software/kooha"

source "$SRK_ROOT/scripts/utils/utils.sh"
log "Installing Kooha ${REF}"
mkdir -p "$(dirname "${DEST}")"
if [ ! -d "$DEST" ]; then
    git clone "$REPO" "$DEST"
fi
(
    cd "$DEST"
    git fetch --all
    git reset --hard >/dev/null
    git clean -dfx
    git checkout "$REF"

    echo "rust 1.78.0" >.tool-versions
    mise install
    export PATH="$(mise where rust)/bin:$PATH"
    export CARGO_HOME="$(mise where rust)"
    export RUSTUP_HOME="$(mise where rust)"
    meson _build --prefix="$(pwd)/__install__"
    ninja -C _build install
    (
        cd __install__
        cp -r bin /usr/local/
        cp -r share /usr/local/
    )
)
mkdir -p "$HOME/bin"
rm -rf "$HOME/bin/grim"
ln -s "$DEST/build/grim" "$HOME/bin/grim"
