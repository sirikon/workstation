tasks:
  default:
    labels:
      apt.packages: "sublime-text sublime-merge"
      autorequire: "true"
    requires: [subl-config, smerge-config, apt-source]

  subl-config:
    script: |
      config_path="$(realpath "$EBRO_TASK_WORKING_DIRECTORY/../config/sublime-text")"
      ln -fs "${config_path}" "$HOME/.config/sublime-text/Packages/User"
    when:
      check_fails: |
        [ "$(readlink "$HOME/.config/sublime-text/Packages/User")" == "$(realpath "$EBRO_TASK_WORKING_DIRECTORY/../config/sublime-text")" ]

  smerge-config:
    script: |
      config_path="$(realpath "$EBRO_TASK_WORKING_DIRECTORY/../config/sublime-merge")"
      ln -fs "${config_path}" "$HOME/.config/sublime-merge/Packages/User"
    when:
      check_fails: |
        [ "$(readlink "$HOME/.config/sublime-merge/Packages/User")" == "$(realpath "$EBRO_TASK_WORKING_DIRECTORY/../config/sublime-merge")" ]

  apt-source:
    requires: [apt-key]
    required_by: [":apt"]
    interactive: true
    script: |
      echo "deb https://download.sublimetext.com/ apt/stable/" | sudo tee /etc/apt/sources.list.d/sublime-text.list
    when:
      check_fails: test -f /etc/apt/sources.list.d/sublime-text.list

  apt-key:
    required_by: [":apt"]
    interactive: true
    script: |
      wget -qO - https://download.sublimetext.com/sublimehq-pub.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/sublimehq-archive.gpg > /dev/null
    when:
      check_fails: test -f /etc/apt/trusted.gpg.d/sublimehq-archive.gpg
